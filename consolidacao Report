'Codigo VBA desenvolvido para otimizar processo de consolidacao dos report do VTEX
'Usuária do macro Izadora
'Desenvolvido por Ronaldo Akio
'Ultima atualização 18/09/2024

Dim comeco As Date
Dim count_arquivo As Integer
Dim cell As Range
Dim lastRow As Long

' Procedure : TurnOffFunctionality
' Purpose   : Turn off automatic calculations, events and screen updating
Public Sub TurnOffFunctionality()
    'Application.Calculation = xlCalculationManual
    Application.DisplayStatusBar = False
    Application.EnableEvents = False
    Application.ScreenUpdating = False
End Sub

' Procedure : TurnOnFunctionality
' Purpose   : turn on automatic calculations, events and screen updating
Public Sub TurnOnFunctionality()
    'Application.Calculation = xlCalculationAutomatic
    Application.DisplayStatusBar = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub

Sub Consolidar()
    'funcao para otimizar velocidade de processamento
    TurnOffFunctionality
    
    'variavel para controle de performance
    comeco = Now()
    
    'pasta onde os arquivos a serem consolidados vão estar
    'arquivos devem estar zipados, como *.CSV
    pasta = "C:\Users\Administrador\Documents\Izadora\csv\"
    
    'pega os arquivos da pasta
    arquivo = Dir(pasta)
    
    'variaveis iniciais
    linha_destino = 2
    linha = 2
    count_arquivo = 0
    
        'loop de arquivos para realizar a consolidação
        Do Until arquivo = ""

            Workbooks.Open (pasta & arquivo), Local:=True
            
            ultima_linha = Workbooks(arquivo).Sheets(1).UsedRange.Rows.Count
            
            ThisWorkbook.Sheets(1).Range("A" & linha_destino & ":CP" & linha_destino + ultima_linha).Value2 = Workbooks(arquivo).Sheets(1).Range("A" & linha & ":CP" & ultima_linha).Value2
            
            linha_destino = linha_destino + ultima_linha - 1
            
            'contador para checagem
            count_arquivo = count_arquivo + 1
            
            'fecha o arquivo sem salvar
            Workbooks(arquivo).Close SaveChanges:=False
            
            arquivo = Dir()
            
         Loop
         
        'bug que esta acontecendo, não sei o motivo
        'deleto as 2 ultimas linhas apos consolidação
        '   Find last row in column C
        lastRow = Cells(Rows.Count, "C").End(xlUp).Row
            
        '   Delete last two rows
        Rows(lastRow - 1 & ":" & lastRow).Delete
        
        'removo possiveis problemas que vieram da base de report
        For Each cell In Range("A:A")
            If cell.Value2 Like "*Error transforming*" Then
                cell.EntireRow.Delete
            End If
        Next cell
        
    
     'funcao para ligar novamente funcionalidades que foram desativados no começo da funcao
     TurnOnFunctionality
     
     'mensagem para controle de performance, em produção comentar essa linha
     Call MsgBox("Tempo de execução: " & Format(Now() - comeco, "hh:mm:ss") & " , " & count_arquivo & " arquivos processados!")
End Sub
